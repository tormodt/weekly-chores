<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simon & Noah's Oppgavejakt! üèÜ</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <h1>üèÜ Simon & Noah's Oppgavejakt!</h1>
            <div class="points-display">
                <div class="child-points">
                    <span class="child-name">Simon:</span>
                    <span class="points">{{ simonPoints }}</span>
                </div>
                <div class="child-points">
                    <span class="child-name">Noah:</span>
                    <span class="points">{{ noahPoints }}</span>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <button 
                v-for="tab in tabs" 
                :key="tab.id"
                :class="['tab-button', { active: activeTab === tab.id }]"
                @click="activeTab = tab.id"
            >
                <span class="tab-icon">{{ tab.icon }}</span>
                <span class="tab-text">{{ tab.name }}</span>
            </button>
        </nav>

        <!-- Tab Content -->
        <main class="tab-content">
            <!-- Oppgaver Tab -->
            <div v-if="activeTab === 'oppgaver'" class="tab-panel">
                <div class="add-task-section">
                    <h2>Legg til ny oppgave</h2>
                    <form @submit.prevent="saveNewTask" class="task-form">
                        <div class="form-group">
                            <label for="taskText">Oppgavetekst:</label>
                            <input 
                                type="text" 
                                id="taskText" 
                                v-model="newTask.text" 
                                placeholder="Skriv oppgaven her..."
                                required
                            >
                        </div>
                        <div class="form-group">
                            <label for="taskPoints">Poeng:</label>
                            <input 
                                type="number" 
                                id="taskPoints" 
                                v-model.number="newTask.points" 
                                min="1" 
                                max="10"
                                required
                            >
                        </div>
                        <div class="form-group">
                            <label for="taskChild">Hvem:</label>
                            <select id="taskChild" v-model="newTask.child" required>
                                <option value="">Velg barn</option>
                                <option value="simon">Simon</option>
                                <option value="noah">Noah</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Legg til oppgave</button>
                    </form>
                </div>

                <div class="tasks-section">
                    <h2>Oppgaver for uke {{ getCurrentWeekNumber() }}, {{ getCurrentYear() }}</h2>
                    <div class="tasks-grid">
                        <div v-for="day in ['Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag', 'L√∏rdag', 'S√∏ndag']" :key="day" class="day-column">
                            <h3 class="day-header">{{ day }}</h3>
                            <div class="tasks-list">
                                <div 
                                    v-for="task in getTasksForDay(day)" 
                                    :key="task.id" 
                                    :class="['task-item', { completed: task.completed }]"
                                >
                                    <div class="task-content">
                                        <span class="task-text">{{ task.text }}</span>
                                        <span class="task-points">{{ task.points }}p</span>
                                        <span class="task-child">{{ task.child }}</span>
                                    </div>
                                    <div class="task-actions">
                                        <button 
                                            v-if="!task.completed" 
                                            @click="completeTask(task.id)" 
                                            class="btn btn-success btn-sm"
                                        >
                                            ‚úì
                                        </button>
                                        <button 
                                            v-if="task.completed && !task.approved" 
                                            @click="approveTask(task.id)" 
                                            class="btn btn-warning btn-sm"
                                        >
                                            Godkjenn
                                        </button>
                                        <button 
                                            v-if="task.completed && !task.approved" 
                                            @click="rejectTask(task.id)" 
                                            class="btn btn-danger btn-sm"
                                        >
                                            Avvis
                                        </button>
                                        <button 
                                            v-if="task.approved" 
                                            @click="editTask(task)" 
                                            class="btn btn-info btn-sm"
                                        >
                                            Rediger
                                        </button>
                                        <button 
                                            @click="deleteTask(task.id)" 
                                            class="btn btn-danger btn-sm"
                                        >
                                            Slett
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Godkjenning Tab -->
            <div v-if="activeTab === 'godkjenning'" class="tab-panel">
                <h2>Ventende godkjenninger</h2>
                <div v-if="pendingApprovals.length === 0" class="no-approvals">
                    <p>Ingen oppgaver venter p√• godkjenning</p>
                </div>
                <div v-else class="approvals-list">
                    <div v-for="approval in pendingApprovals" :key="approval.id" class="approval-item">
                        <div class="approval-content">
                            <h3>{{ approval.taskText }}</h3>
                            <p><strong>{{ approval.child }}</strong> - {{ approval.points }} poeng</p>
                            <p class="approval-date">{{ formatDate(approval.createdAt) }}</p>
                        </div>
                        <div class="approval-actions">
                            <button @click="approveTask(approval.taskId)" class="btn btn-success">Godkjenn</button>
                            <button @click="rejectTask(approval.taskId)" class="btn btn-danger">Avvis</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historikk Tab -->
            <div v-if="activeTab === 'historikk'" class="tab-panel">
                <h2>Oppgavehistorikk</h2>
                <div class="history-filters">
                    <select v-model="selectedYear" @change="loadHistoryForYear">
                        <option v-for="year in getSortedYears()" :key="year" :value="year">{{ year }}</option>
                    </select>
                    <select v-model="selectedWeek" @change="loadHistoryForWeek">
                        <option v-for="week in getSortedWeeks(selectedYear)" :key="week" :value="week">Uke {{ week }}</option>
                    </select>
                </div>
                <div v-if="historyTasks.length === 0" class="no-history">
                    <p>Ingen oppgaver funnet for valgt periode</p>
                </div>
                <div v-else class="history-tasks">
                    <div v-for="task in historyTasks" :key="task.id" class="history-task">
                        <div class="task-info">
                            <span class="task-text">{{ task.text }}</span>
                            <span class="task-points">{{ task.points }}p</span>
                            <span class="task-child">{{ task.child }}</span>
                        </div>
                        <div class="task-status">
                            <span v-if="task.approved" class="status-approved">Godkjent</span>
                            <span v-else-if="task.completed" class="status-pending">Venter godkjenning</span>
                            <span v-else class="status-incomplete">Ikke fullf√∏rt</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Poeng Tab -->
            <div v-if="activeTab === 'poeng'" class="tab-panel">
                <div class="points-overview">
                    <div class="points-summary">
                        <h2>Poengoversikt</h2>
                        <div class="total-points">
                            <div class="total-points-card">
                                <h3>Totalt</h3>
                                <div class="children-totals">
                                    <div class="child-total">
                                        <span class="child-name">Simon:</span>
                                        <span class="total-points-value">{{ getTotalPoints().simon }}</span>
                                    </div>
                                    <div class="child-total">
                                        <span class="child-name">Noah:</span>
                                        <span class="total-points-value">{{ getTotalPoints().noah }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="points-by-year">
                        <h3>Poeng per uke og √•r</h3>
                        <div v-for="year in getSortedYears()" :key="year" class="year-section">
                            <h4 class="year-header">{{ year }}</h4>
                            <div class="weeks-container">
                                <div v-for="week in getSortedWeeks(year)" :key="week" class="week-card">
                                    <div class="week-header">
                                        <h5>Uke {{ week }}</h5>
                                        <div class="week-total">
                                            <span>Simon: {{ getPointsByWeekAndYear(year, week).simon }}</span>
                                            <span>Noah: {{ getPointsByWeekAndYear(year, week).noah }}</span>
                                        </div>
                                    </div>
                                    <div class="week-children">
                                        <div class="week-child">
                                            <span class="child-name">Simon:</span>
                                            <span class="points">{{ getPointsByWeekAndYear(year, week).simon }}</span>
                                        </div>
                                        <div class="week-child">
                                            <span class="child-name">Noah:</span>
                                            <span class="points">{{ getPointsByWeekAndYear(year, week).noah }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Edit Task Modal -->
        <div v-if="editingTaskId" class="modal-overlay" @click="cancelTaskEdit">
            <div class="modal" @click.stop>
                <h3>Rediger oppgave</h3>
                <form @submit.prevent="saveTaskEdit">
                    <div class="form-group">
                        <label for="editText">Oppgavetekst:</label>
                        <input 
                            type="text" 
                            id="editText" 
                            v-model="editingTaskTitle" 
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="editPoints">Poeng:</label>
                        <input 
                            type="number" 
                            id="editPoints" 
                            v-model.number="editingTaskStars" 
                            min="1" 
                            max="10"
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="editChild">Hvem:</label>
                        <select id="editChild" v-model="editingTaskChild" required>
                            <option value="simon">Simon</option>
                            <option value="noah">Noah</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Lagre</button>
                        <button type="button" @click="cancelTaskEdit" class="btn btn-secondary">Avbryt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration from environment variables
        const firebaseConfig = {
            apiKey: import.meta.env.VITE_FIREBASE_API_KEY || "AIzaSyDDBrcI5dZWgZD2J1ahtY8unYOJOTtcTCE",
            authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN || "chores-3cde1.firebaseapp.com",
            projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID || "chores-3cde1",
            storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET || "chores-3cde1.firebasestorage.app",
            messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID || "985200279642",
            appId: import.meta.env.VITE_FIREBASE_APP_ID || "1:985200279642:web:c02591d9ab43eb414dd863",
            measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID || "G-L3C6S2RP58"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebase = { db, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, setDoc };
        
        // Signal that Firebase is ready
        window.firebaseReady = true;
        console.log('Firebase SDK loaded and ready');
    </script>
    
    <!-- Embedded Firebase Service -->
    <script>
        // Simplified Firestore Service embedded directly
        console.log('Loading embedded Firebase service...');

        class SimpleFirestoreService {
          constructor() {
            this.db = null;
            this.initialized = false;
            this.initPromise = this.initialize();
          }

          async initialize() {
            console.log('üîÑ Initializing Firestore...');
            
            // Wait for Firebase to be available
            let attempts = 0;
            while (!window.firebase && attempts < 100) {
              await new Promise(resolve => setTimeout(resolve, 100));
              attempts++;
            }
            
            if (window.firebase) {
              this.db = window.firebase.db;
              this.initialized = true;
              console.log('‚úÖ Firebase initialized successfully');
              return true;
            } else {
              console.error('‚ùå Firebase failed to initialize after 10 seconds');
              return false;
            }
          }

          getCurrentWeekNumber() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            const days = Math.floor((now - start) / (24 * 60 * 60 * 1000));
            return Math.ceil((days + start.getDay() + 1) / 7);
          }

          async addTask(task) {
            await this.initPromise;
            
            if (!this.initialized) {
              throw new Error('Firebase not initialized');
            }

            try {
              console.log('üìù Adding task to Firestore:', task);
              
              const taskData = {
                ...task,
                createdAt: new Date(),
                updatedAt: new Date()
              };
              
              // Store in hierarchical structure: years/{year}/weeks/{week}/tasks/{taskId}
              const year = task.year || new Date().getFullYear();
              const week = task.week || this.getCurrentWeekNumber();
              
              const docRef = await window.firebase.addDoc(
                window.firebase.collection(this.db, `years/${year}/weeks/${week}/tasks`), 
                taskData
              );
              
              console.log('‚úÖ Task added successfully with ID:', docRef.id);
              return { id: docRef.id, ...taskData };
            } catch (error) {
              console.error('‚ùå Error adding task to Firestore:', error);
              throw error;
            }
          }

          async updateTask(taskId, updates) {
            await this.initPromise;
            
            if (!this.initialized) {
              throw new Error('Firebase not initialized');
            }

            try {
              console.log('üìù Updating task in Firestore:', taskId, updates);
              
              // Find the task in the hierarchical structure
              const task = await this.findTaskInHierarchy(taskId);
              if (!task) {
                console.error('‚ùå Task not found:', taskId);
                return false;
              }
              
              const docRef = window.firebase.doc(this.db, `years/${task.year}/weeks/${task.week}/tasks`, taskId);
              await window.firebase.updateDoc(docRef, {
                ...updates,
                updatedAt: new Date()
              });
              
              console.log('‚úÖ Task updated successfully');
              return true;
            } catch (error) {
              console.error('‚ùå Error updating task in Firestore:', error);
              throw error;
            }
          }

          async deleteTask(taskId) {
            await this.initPromise;
            
            if (!this.initialized) {
              throw new Error('Firebase not initialized');
            }

            try {
              console.log('üìù Deleting task from Firestore:', taskId);
              
              // Find the task in the hierarchical structure
              const task = await this.findTaskInHierarchy(taskId);
              if (!task) {
                console.error('‚ùå Task not found:', taskId);
                return false;
              }
              
              const docRef = window.firebase.doc(this.db, `years/${task.year}/weeks/${task.week}/tasks`, taskId);
              await window.firebase.deleteDoc(docRef);
              
              console.log('‚úÖ Task deleted successfully');
              return true;
            } catch (error) {
              console.error('‚ùå Error deleting task from Firestore:', error);
              throw error;
            }
          }

          async findTaskInHierarchy(taskId) {
            // This is a simplified version - in a real app you'd want to query more efficiently
            const years = await this.getAllYears();
            for (const year of years) {
              const weeks = await this.getWeeksForYear(year);
              for (const week of weeks) {
                const tasks = await this.getTasksForWeek(year, week);
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                  return { ...task, year, week };
                }
              }
            }
            return null;
          }

          async getAllYears() {
            // This would need to be implemented based on your Firestore structure
            // For now, return current year
            return [new Date().getFullYear()];
          }

          async getWeeksForYear(year) {
            // This would need to be implemented based on your Firestore structure
            // For now, return current week
            return [this.getCurrentWeekNumber()];
          }

          async getTasksForWeek(year, week) {
            try {
              const tasksRef = window.firebase.collection(this.db, `years/${year}/weeks/${week}/tasks`);
              const snapshot = await window.firebase.getDocs(tasksRef);
              return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
              console.error('‚ùå Error getting tasks for week:', error);
              return [];
            }
          }

          async subscribeToTasks(callback) {
            await this.initPromise;
            
            if (!this.initialized) {
              throw new Error('Firebase not initialized');
            }

            try {
              // Subscribe to all tasks across all years and weeks
              const years = await this.getAllYears();
              const allTasks = [];
              
              for (const year of years) {
                const weeks = await this.getWeeksForYear(year);
                for (const week of weeks) {
                  const tasksRef = window.firebase.collection(this.db, `years/${year}/weeks/${week}/tasks`);
                  window.firebase.onSnapshot(tasksRef, (snapshot) => {
                    const weekTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Update the specific week's tasks and trigger callback with all tasks
                    this.updateTasksForWeek(year, week, weekTasks);
                    callback(this.getAllTasksFromHierarchy());
                  });
                }
              }
            } catch (error) {
              console.error('‚ùå Error setting up task subscription:', error);
              throw error;
            }
          }

          updateTasksForWeek(year, week, tasks) {
            // This would update an internal cache of tasks by year/week
            // Implementation depends on your specific needs
          }

          getAllTasksFromHierarchy() {
            // This would return all tasks from the hierarchical structure
            // Implementation depends on your specific needs
            return [];
          }

          async addPendingApproval(approval) {
            await this.initPromise;
            
            if (!this.initialized) {
              throw new Error('Firebase not initialized');
            }

            try {
              console.log('üìù Adding pending approval to Firestore:', approval);
              
              const docRef = await window.firebase.addDoc(
                window.firebase.collection(this.db, 'pendingApprovals'), 
                { ...approval, createdAt: new Date() }
              );
              
              console.log('‚úÖ Pending approval added successfully with ID:', docRef.id);
              return { id: docRef.id, ...approval };
            } catch (error) {
              console.error('‚ùå Error adding pending approval to Firestore:', error);
              throw error;
            }
          }

          async removePendingApproval(approvalId) {
            await this.initPromise;
            
            if (!this.initialized) {
              throw new Error('Firebase not initialized');
            }

            try {
              console.log('üìù Removing pending approval from Firestore:', approvalId);
              
              const docRef = window.firebase.doc(this.db, 'pendingApprovals', approvalId);
              await window.firebase.deleteDoc(docRef);
              
              console.log('‚úÖ Pending approval removed successfully');
              return true;
            } catch (error) {
              console.error('‚ùå Error removing pending approval from Firestore:', error);
              throw error;
            }
          }

          async subscribeToPendingApprovals(callback) {
            await this.initPromise;
            
            if (!this.initialized) {
              throw new Error('Firebase not initialized');
            }

            try {
              const approvalsRef = window.firebase.collection(this.db, 'pendingApprovals');
              window.firebase.onSnapshot(approvalsRef, (snapshot) => {
                const approvals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                callback(approvals);
              });
            } catch (error) {
              console.error('‚ùå Error setting up pending approvals subscription:', error);
              throw error;
            }
          }

          async updatePoints(simonPoints, noahPoints) {
            await this.initPromise;
            
            if (!this.initialized) {
              throw new Error('Firebase not initialized');
            }

            try {
              console.log('üìù Updating points in Firestore:', { simonPoints, noahPoints });
              
              const pointsRef = window.firebase.doc(this.db, 'points', 'current');
              await window.firebase.setDoc(pointsRef, {
                simonPoints,
                noahPoints,
                updatedAt: new Date()
              }, { merge: true });
              
              console.log('‚úÖ Points updated successfully');
              return true;
            } catch (error) {
              console.error('‚ùå Error updating points in Firestore:', error);
              throw error;
            }
          }

          async testConnection() {
            await this.initPromise;
            
            if (!this.initialized) {
              console.log('‚ùå Firebase not initialized');
              return false;
            }

            try {
              console.log('üß™ Testing Firestore connection...');
              
              const testDoc = {
                test: true,
                timestamp: new Date().toISOString(),
                message: 'Connection test from weekly-chores app'
              };
              
              const docRef = await window.firebase.addDoc(
                window.firebase.collection(this.db, 'test'), 
                testDoc
              );
              
              console.log('‚úÖ Test document created with ID:', docRef.id);
              
              // Clean up
              await window.firebase.deleteDoc(
                window.firebase.doc(this.db, 'test', docRef.id)
              );
              
              console.log('‚úÖ Test document deleted');
              return true;
            } catch (error) {
              console.error('‚ùå Firestore connection test failed:', error);
              return false;
            }
          }
        }

        // Make available globally
        window.SimpleFirestoreService = SimpleFirestoreService;
        console.log('SimpleFirestoreService class defined and available globally');

        // Signal that the Firebase service is ready
        window.firestoreServiceReady = true;
        console.log('Firestore service ready flag set');
    </script>
    
    <!-- Main App -->
    <script src="app.js"></script>
</body>
</html>
